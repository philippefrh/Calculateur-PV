import React, { useState, useEffect } from "react";
import "./App.css";
import axios from "axios";

const BACKEND_URL = process.env.REACT_APP_BACKEND_URL;
const API = `${BACKEND_URL}/api`;

// Logo d'autonomie - Composant principal demand√©
const AutonomyLogo = () => (
  <div className="autonomy-logo-container">
    <div className="autonomy-logo">
      <div className="autonomy-section red">
        <span className="autonomy-text">POURCENTAGE D'AUTONOMIE DE COULEUR ROUGE TROUV√â = Ne permet pas l'envois de votre dossier en commission</span>
        <span className="autonomy-status negative">N√©gatif</span>
      </div>
      <div className="autonomy-section green">
        <span className="autonomy-text">POURCENTAGE D'AUTONOMIE DE COULEUR VERT TROUV√â = Permet l'envois de votre dossier en commission</span>
        <span className="autonomy-status positive">Positif</span>
      </div>
    </div>
  </div>
);

// √âcran de d√©marrage am√©lior√© avec vrais logos
const StartScreen = ({ onStart, clientMode, setClientMode }) => {
  
  const handleClick = () => {
    console.log("Button clicked!");
    console.log("Client mode:", clientMode);
    onStart();
  };
  
  const handleModeChange = (mode) => {
    setClientMode(mode);
    console.log("Mode changed to:", mode);
  };
  
  return (
    <div className="start-screen">
      {/* Toggle Mode Selection */}
      <div className="mode-selector">
        <div className="mode-toggle-container">
          <div className="mode-toggle">
            <button 
              className={`mode-toggle-btn ${clientMode === 'particuliers' ? 'active' : ''}`}
              onClick={() => handleModeChange('particuliers')}
            >
              üë• Particuliers
            </button>
            <button 
              className={`mode-toggle-btn ${clientMode === 'professionnels' ? 'active' : ''}`}
              onClick={() => handleModeChange('professionnels')}
            >
              üè¢ Professionnels
            </button>
          </div>
          <div className="mode-description">
            {clientMode === 'particuliers' ? (
              <p>üè† Calculateur sp√©cialis√© pour les particuliers et r√©sidences priv√©es</p>
            ) : (
              <p>üè¢ Calculateur sp√©cialis√© pour les entreprises et professionnels</p>
            )}
          </div>
        </div>
      </div>

      {/* Logo FRH Environnement officiel */}
      <div className="company-header">
        <div className="company-image">
          <img 
            src="https://cdn-dhoin.nitrocdn.com/EuBhgITwlcEgvZudhGdVBYWQskHAaTgE/assets/images/optimized/rev-a144ac5/france-renovhabitat.fr/contenu/2021/uploads/2021/05/FRH2-logo-HORIZONTALE.png" 
            alt="FRH Environnement - Installateur Photovolta√Øque"
            className="company-logo-image centered"
          />
        </div>
        <h1 className="company-title">Installateur Photovolta√Øque</h1>
        <p className="company-subtitle">
          FRH ENVIRONNEMENT - √ânergie Solaire {clientMode === 'particuliers' ? 'R√©sidentiel' : 'Professionnel'}
        </p>
        <div className="company-stats">
          <div className="stat-item">
            <span className="stat-number">+ de 5000</span>
            <span className="stat-label">Installations r√©alis√©es</span>
          </div>
          <div className="stat-item">
            <span className="stat-number">86%</span>
            <span className="stat-label">de clients nous recommandent</span>
          </div>
        </div>
      </div>
      
      <AutonomyLogo />
      
      {/* Logos officiels des certifications */}
      <div className="certifications">
        <div className="cert-row">
          <div className="cert-badge official rge-qualipv">
            <img src="https://www.qualit-enr.org/wp-content/uploads/2024/12/logo-QualiPV-2025-RGE_sc.png" alt="RGE QualiPV 2025" className="rge-logo-small" />
            <span>RGE QualiPV 2025</span>
          </div>
          <div className="cert-badge official rge-qualipac">
            <img src="https://www.qualit-enr.org/wp-content/uploads/2024/12/logo-QualiPAC-2025-RGE_sc.png" alt="RGE QualiPac 2025" className="rge-logo-small" />
            <span>RGE QualiPac 2025</span>
          </div>
        </div>
        
        <div className="cert-row">
          <div className="cert-badge official ffb">
            <img src="https://www.ffbatiment.fr/-/media/Project/FFB/shared/Logos/logo-federation-francaise-du-batiment.png?h=196&iar=0&w=240&rev=f33feb1bc41b4da682356e6820f4cf36&hash=89C478B0995E262614796430902176D4" alt="FFB Adh√©rent" className="ffb-logo" />
            <span>FFB Adh√©rent</span>
          </div>
          <div className="cert-badge official edf">
            <img src="https://www.dometis.re/wp-content/uploads/2025/05/agir-plus.png" alt="Partenaire AGIR PLUS EDF" className="agir-plus-logo" />
            <span>‚ö° Partenaire AGIR PLUS EDF</span>
          </div>
        </div>
        
        <div className="cert-row">
          <div className="cert-badge official mma-decennale centered">
            <img src="https://www.mma.fr/files/live/sites/mmafr/files/divers/logo_mma.png" alt="MMA Assurance D√©cennale" className="mma-logo-centered" />
            <div className="decennale-text">
              <h4>D√©cennale</h4>
              <p>Toutes nos installations b√©n√©ficient d'une garantie de 10 ans.</p>
            </div>
          </div>
        </div>
      </div>
      
      <button className="start-button" onClick={handleClick}>
        {clientMode === 'particuliers' ? 
          'üåû Commencer l\'√âtude Solaire Gratuite' : 
          'üè¢ Commencer l\'√âtude Solaire Professionnelle'
        }
      </button>
      
      <div className="benefits">
        <div className="benefit-item">
          <span className="benefit-icon">‚úì</span>
          <span>
            {clientMode === 'particuliers' ? 
              'R√©alisez jusqu\'√† 70% d\'√©conomies sur vos factures d\'√©lectricit√©' :
              'R√©duisez vos co√ªts √©nerg√©tiques et b√©n√©ficiez d\'avantages fiscaux'
            }
          </span>
        </div>
        <div className="benefit-item">
          <span className="benefit-icon">‚úì</span>
          <span>Un accompagnement de A √† Z pour votre projet solaire</span>
        </div>
        <div className="benefit-item">
          <span className="benefit-icon">‚úì</span>
          <span>
            {clientMode === 'particuliers' ? 
              'Panneaux garantis 25 ans et garanties de production' :
              'Solutions professionnelles avec garanties √©tendues'
            }
          </span>
        </div>
        <div className="benefit-item">
          <span className="benefit-icon">‚úì</span>
          <span>Installation fiable et performante par nos installateurs certifi√©s RGE</span>
        </div>
        <div className="benefit-item">
          <span className="benefit-icon">‚úì</span>
          <span>
            {clientMode === 'particuliers' ? 
              'Profitez des dispositifs d\'aides et de subventions' :
              'Amortissement acc√©l√©r√© et avantages fiscaux pour entreprises'
            }
          </span>
        </div>
      </div>

      <div className="contact-info">
        <p><strong>üè¢ FRH Environnement</strong> - 196 Avenue Jean Lolive 93500 Pantin</p>
        <p><strong>üìû</strong> 09 85 60 50 51 | <strong>‚úâÔ∏è</strong> contact@francerenovhabitat.com</p>
      </div>
    </div>
  );
};

// Formulaire √©tape 1 - Informations personnelles am√©lior√©
const PersonalInfoForm = ({ formData, setFormData, onNext, onPrevious }) => {
  const [errors, setErrors] = useState({});

  const validateForm = () => {
    const newErrors = {};
    if (!formData.firstName.trim()) newErrors.firstName = "Le pr√©nom est obligatoire";
    if (!formData.lastName.trim()) newErrors.lastName = "Le nom est obligatoire";
    if (!formData.address.trim()) newErrors.address = "L'adresse est obligatoire";
    
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (validateForm()) {
      onNext();
    }
  };

  return (
    <div className="form-container">
      <div className="form-header">
        <h2>üìã √âtape 1/4 - Informations Personnelles</h2>
        <div className="progress-bar">
          <div className="progress-fill" style={{width: '25%'}}></div>
        </div>
      </div>
      
      <form onSubmit={handleSubmit}>
        <div className="form-group">
          <label>üë§ Pr√©nom *</label>
          <input
            type="text"
            value={formData.firstName}
            onChange={(e) => setFormData({...formData, firstName: e.target.value})}
            placeholder="Votre pr√©nom"
            className={errors.firstName ? 'error' : ''}
            required
          />
          {errors.firstName && <span className="error-message">{errors.firstName}</span>}
        </div>
        
        <div className="form-group">
          <label>üë§ Nom *</label>
          <input
            type="text"
            value={formData.lastName}
            onChange={(e) => setFormData({...formData, lastName: e.target.value})}
            placeholder="Votre nom de famille"
            className={errors.lastName ? 'error' : ''}
            required
          />
          {errors.lastName && <span className="error-message">{errors.lastName}</span>}
        </div>
        
        <div className="form-group">
          <label>üè† Adresse exacte de votre domicile *</label>
          <input
            type="text"
            value={formData.address}
            onChange={(e) => setFormData({...formData, address: e.target.value})}
            placeholder="10 Avenue des Champs-√âlys√©es, 75008 Paris"
            className={errors.address ? 'error' : ''}
            required
          />
          {errors.address && <span className="error-message">{errors.address}</span>}
          <small>üí° Cette adresse sera utilis√©e pour calculer pr√©cis√©ment votre potentiel solaire</small>
        </div>
        
        <div className="form-buttons">
          <button type="button" onClick={onPrevious} className="prev-button">‚¨ÖÔ∏è Pr√©c√©dent</button>
          <button type="submit" className="next-button">Suivant ‚û°Ô∏è</button>
        </div>
      </form>
    </div>
  );
};

// Formulaire √©tape 2 - Informations techniques am√©lior√©
const TechnicalInfoForm = ({ formData, setFormData, onNext, onPrevious }) => {
  const [errors, setErrors] = useState({});

  const validateForm = () => {
    const newErrors = {};
    if (!formData.roofSurface || formData.roofSurface < 10) newErrors.roofSurface = "Surface minimum : 10 m¬≤";
    if (!formData.roofOrientation) newErrors.roofOrientation = "Orientation obligatoire";
    
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (validateForm()) {
      onNext();
    }
  };

  const getOrientationAdvice = (orientation) => {
    const advice = {
      "Sud": "üåü Excellente orientation ! Production optimale",
      "Sud-Est": "üëç Tr√®s bonne orientation, production matinale",
      "Sud-Ouest": "üëç Tr√®s bonne orientation, production tardive", 
      "Est": "‚ö†Ô∏è Orientation correcte, production matinale",
      "Ouest": "‚ö†Ô∏è Orientation correcte, production tardive"
    };
    return advice[orientation] || "";
  };

  return (
    <div className="form-container">
      <div className="form-header">
        <h2>üè† √âtape 2/4 - Informations Techniques</h2>
        <div className="progress-bar">
          <div className="progress-fill" style={{width: '50%'}}></div>
        </div>
      </div>
      
      <form onSubmit={handleSubmit}>
        <div className="form-group">
          <label>üìê Surface de votre toiture la mieux orient√©e (m¬≤) *</label>
          <input
            type="number"
            value={formData.roofSurface}
            onChange={(e) => setFormData({...formData, roofSurface: e.target.value})}
            placeholder="ex: 50"
            min="10"
            max="200"
            className={errors.roofSurface ? 'error' : ''}
            required
          />
          {errors.roofSurface && <span className="error-message">{errors.roofSurface}</span>}
          <small>üí° Chaque panneau fait 2,1 m¬≤ - Surface minimum 10 m¬≤ (‚âà 5 panneaux)</small>
        </div>
        
        <div className="form-group">
          <label>üß≠ Orientation de votre toiture *</label>
          <select
            value={formData.roofOrientation}
            onChange={(e) => setFormData({...formData, roofOrientation: e.target.value})}
            className={errors.roofOrientation ? 'error' : ''}
            required
          >
            <option value="">S√©lectionnez une orientation</option>
            <option value="Sud">üåû Sud (Optimal)</option>
            <option value="Sud-Est">üåÖ Sud-Est (Tr√®s bon)</option>
            <option value="Sud-Ouest">üåá Sud-Ouest (Tr√®s bon)</option>
            <option value="Est">‚¨ÖÔ∏è Est (Correct)</option>
            <option value="Ouest">‚û°Ô∏è Ouest (Correct)</option>
          </select>
          {errors.roofOrientation && <span className="error-message">{errors.roofOrientation}</span>}
          {formData.roofOrientation && (
            <div className="orientation-advice">{getOrientationAdvice(formData.roofOrientation)}</div>
          )}
        </div>
        
        <div className="form-group">
          <label>ü™ü Nombre de velux sur votre toiture</label>
          <input
            type="number"
            value={formData.veluxCount}
            onChange={(e) => setFormData({...formData, veluxCount: e.target.value})}
            min="0"
            max="10"
            placeholder="0 si aucun"
          />
          <small>üí° Les velux peuvent limiter l'espace disponible pour les panneaux</small>
        </div>
        
        <div className="form-buttons">
          <button type="button" onClick={onPrevious} className="prev-button">‚¨ÖÔ∏è Pr√©c√©dent</button>
          <button type="submit" className="next-button">Suivant ‚û°Ô∏è</button>
        </div>
      </form>
    </div>
  );
};

// Formulaire √©tape 3 - Syst√®me de chauffage am√©lior√©
const HeatingSystemForm = ({ formData, setFormData, onNext, onPrevious }) => {
  const [errors, setErrors] = useState({});

  const validateForm = () => {
    const newErrors = {};
    if (!formData.heatingSystem) newErrors.heatingSystem = "Syst√®me de chauffage obligatoire";
    if (!formData.waterHeatingSystem) newErrors.waterHeatingSystem = "Syst√®me d'eau chaude obligatoire";
    if (!formData.meterType) newErrors.meterType = "Type de compteur obligatoire";
    if (!formData.meterPower) newErrors.meterPower = "Puissance compteur obligatoire";
    if (!formData.phaseType) newErrors.phaseType = "Type de phase obligatoire";
    
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (validateForm()) {
      onNext();
    }
  };

  const getHeatingAdvice = (heating) => {
    if (heating.includes("√©lectrique")) {
      return "‚ö° Parfait pour le solaire ! Vous consommez beaucoup d'√©lectricit√©";
    }
    if (heating.includes("Pompe √† chaleur")) {
      return "üî• Excellente synergie avec le solaire !";
    }
    if (heating.includes("Chemin√©e") || heating.includes("Po√™le")) {
      return "üî• Chauffage au bois - Le solaire compl√®tera parfaitement votre syst√®me";
    }
    return "üè† Installation solaire rentable malgr√© le chauffage non-√©lectrique";
  };

  return (
    <div className="form-container">
      <div className="form-header">
        <h2>üè† √âtape 3/4 - Chauffage et Eau Chaude</h2>
        <div className="progress-bar">
          <div className="progress-fill" style={{width: '75%'}}></div>
        </div>
      </div>
      
      <form onSubmit={handleSubmit}>
        <div className="form-group">
          <label>üî• Syst√®me(s) de chauffage actuel(s) *</label>
          
          {/* Syst√®me principal */}
          <div className="heating-system-selector">
            <label className="system-label">Syst√®me principal :</label>
            <select
              value={formData.heatingSystem || ''}
              onChange={(e) => setFormData({...formData, heatingSystem: e.target.value})}
              className={errors.heatingSystem ? 'error' : ''}
              required
            >
              <option value="">S√©lectionnez votre syst√®me principal</option>
              <option value="Radiateurs √©lectriques">‚ö° Radiateurs √©lectriques</option>
              <option value="Chauffage √©lectrique avec plancher chauffant">‚ö° Plancher chauffant √©lectrique</option>
              <option value="Chaudi√®re Gaz">üî• Chaudi√®re Gaz</option>
              <option value="Chaudi√®re Fuel">üõ¢Ô∏è Chaudi√®re Fuel</option>
              <option value="Chaudi√®re √©lectrique">‚ö° Chaudi√®re √©lectrique</option>
              <option value="Pompe √† chaleur Air-Air r√©versible">‚ùÑÔ∏èüî• Pompe √† chaleur Air-Air (r√©versible)</option>
              <option value="Pompe √† chaleur Air-Eau">üíßüî• Pompe √† chaleur Air-Eau</option>
              <option value="Chemin√©e">üî• Chemin√©e</option>
              <option value="Po√™le √† bois">ü™µ Po√™le √† bois</option>
              <option value="Po√™le √† granul√©">üåæ Po√™le √† granul√©</option>
            </select>
          </div>
          
          {/* Syst√®mes d'appoint */}
          <div className="heating-system-additional">
            <label className="system-label">Syst√®me(s) d'appoint :</label>
            <select
              value=""
              onChange={(e) => {
                if (e.target.value) {
                  const additionalSystems = formData.additionalHeatingSystems || [];
                  if (!additionalSystems.includes(e.target.value)) {
                    setFormData({
                      ...formData, 
                      additionalHeatingSystems: [...additionalSystems, e.target.value]
                    });
                  }
                  e.target.value = '';
                }
              }}
            >
              <option value="">+ Ajouter un syst√®me d'appoint</option>
              <option value="Radiateurs √©lectriques">‚ö° Radiateurs √©lectriques</option>
              <option value="Chauffage √©lectrique avec plancher chauffant">‚ö° Plancher chauffant √©lectrique</option>
              <option value="Chaudi√®re Gaz">üî• Chaudi√®re Gaz</option>
              <option value="Chaudi√®re Fuel">üõ¢Ô∏è Chaudi√®re Fuel</option>
              <option value="Chaudi√®re √©lectrique">‚ö° Chaudi√®re √©lectrique</option>
              <option value="Pompe √† chaleur Air-Air r√©versible">‚ùÑÔ∏èüî• Pompe √† chaleur Air-Air (r√©versible)</option>
              <option value="Pompe √† chaleur Air-Eau">üíßüî• Pompe √† chaleur Air-Eau</option>
              <option value="Chemin√©e">üî• Chemin√©e</option>
              <option value="Po√™le √† bois">ü™µ Po√™le √† bois</option>
              <option value="Po√™le √† granul√©">üåæ Po√™le √† granul√©</option>
            </select>
          </div>
          
          {/* Affichage des syst√®mes d'appoint s√©lectionn√©s */}
          {formData.additionalHeatingSystems && formData.additionalHeatingSystems.length > 0 && (
            <div className="selected-additional-systems">
              <p className="additional-systems-label">Syst√®mes d'appoint s√©lectionn√©s :</p>
              <div className="additional-systems-list">
                {formData.additionalHeatingSystems.map((system, index) => (
                  <div key={index} className="additional-system-item">
                    <span>{system}</span>
                    <button
                      type="button"
                      className="remove-system-btn"
                      onClick={() => {
                        const updatedSystems = formData.additionalHeatingSystems.filter((_, i) => i !== index);
                        setFormData({
                          ...formData,
                          additionalHeatingSystems: updatedSystems
                        });
                      }}
                    >
                      ‚úï
                    </button>
                  </div>
                ))}
              </div>
            </div>
          )}
          
          {errors.heatingSystem && <span className="error-message">{errors.heatingSystem}</span>}
          {formData.heatingSystem && (
            <div className="heating-advice">{getHeatingAdvice(formData.heatingSystem)}</div>
          )}
        </div>
        
        <div className="form-group">
          <label>üíß Syst√®me d'eau chaude sanitaire *</label>
          <select
            value={formData.waterHeatingSystem}
            onChange={(e) => setFormData({...formData, waterHeatingSystem: e.target.value})}
            className={errors.waterHeatingSystem ? 'error' : ''}
            required
          >
            <option value="">S√©lectionnez votre syst√®me</option>
            <option value="Ballon √©lectrique standard">‚ö° Ballon √©lectrique standard</option>
            <option value="Ballon thermodynamique">üîÑ Ballon thermodynamique</option>
          </select>
          {errors.waterHeatingSystem && <span className="error-message">{errors.waterHeatingSystem}</span>}
        </div>
        
        {formData.waterHeatingSystem && (
          <div className="form-group">
            <label>üìè Capacit√© du ballon (litres)</label>
            <input
              type="number"
              value={formData.waterHeatingCapacity}
              onChange={(e) => setFormData({...formData, waterHeatingCapacity: e.target.value})}
              placeholder="ex: 200"
              min="50"
              max="500"
            />
            <small>üí° Information optionnelle - Capacit√© standard : 150-300L</small>
          </div>
        )}
        
        <div className="form-group">
          <label>üß∫ Machine √† laver</label>
          <select
            value={formData.washingMachine || ''}
            onChange={(e) => setFormData({...formData, washingMachine: e.target.value})}
          >
            <option value="">S√©lectionnez le nombre</option>
            <option value="1">1 machine √† laver</option>
            <option value="2">2 machines √† laver</option>
            <option value="3">3 machines √† laver</option>
          </select>
        </div>
        
        <div className="form-group">
          <label>üå¨Ô∏è S√®che linge</label>
          <select
            value={formData.dryer || ''}
            onChange={(e) => setFormData({...formData, dryer: e.target.value})}
          >
            <option value="">Avez-vous un s√®che linge ?</option>
            <option value="oui">Oui</option>
            <option value="non">Non</option>
          </select>
        </div>
        
        <div className="form-group">
          <label>üçΩÔ∏è Lave vaisselle</label>
          <select
            value={formData.dishwasher || ''}
            onChange={(e) => setFormData({...formData, dishwasher: e.target.value})}
          >
            <option value="">Avez-vous un lave vaisselle ?</option>
            <option value="oui">Oui</option>
            <option value="non">Non</option>
          </select>
        </div>
        
        <div className="form-group">
          <label>üßä Frigo</label>
          <select
            value={formData.refrigerator || ''}
            onChange={(e) => setFormData({...formData, refrigerator: e.target.value})}
          >
            <option value="">S√©lectionnez le nombre</option>
            <option value="1">1 frigo</option>
            <option value="2">2 frigos</option>
            <option value="3">3 frigos</option>
          </select>
        </div>
        
        <div className="form-group">
          <label>üî• Four √©lectrique</label>
          <select
            value={formData.electricOven || ''}
            onChange={(e) => setFormData({...formData, electricOven: e.target.value})}
          >
            <option value="">Avez-vous un four √©lectrique ?</option>
            <option value="oui">Oui</option>
            <option value="non">Non</option>
          </select>
        </div>
        
        <div className="form-group">
          <label>üç≥ Plaque de cuisson</label>
          <select
            value={formData.cookingPlate || ''}
            onChange={(e) => setFormData({...formData, cookingPlate: e.target.value})}
          >
            <option value="">S√©lectionnez le type</option>
            <option value="electrique">‚ö° √âlectrique</option>
            <option value="gaz">üî• Gaz</option>
          </select>
        </div>
        
        <div className="form-group">
          <label>üí® Hotte aspirante</label>
          <select
            value={formData.hood || ''}
            onChange={(e) => setFormData({...formData, hood: e.target.value})}
          >
            <option value="">Avez-vous une hotte aspirante ?</option>
            <option value="oui">Oui</option>
            <option value="non">Non</option>
          </select>
        </div>
        
        <div className="form-group">
          <label>üåÄ VMC (Ventilation M√©canique Contr√¥l√©e)</label>
          <select
            value={formData.vmc || ''}
            onChange={(e) => setFormData({...formData, vmc: e.target.value})}
          >
            <option value="">S√©lectionnez le type de VMC</option>
            <option value="simple_flux">üåÄ Simple flux</option>
            <option value="double_flux">üåÄüåÄ Double flux</option>
            <option value="non">Non</option>
          </select>
        </div>
        
        <div className="form-group">
          <label>üîå Quel type de compteur *</label>
          <select
            value={formData.meterType}
            onChange={(e) => setFormData({...formData, meterType: e.target.value})}
            className={errors.meterType ? 'error' : ''}
            required
          >
            <option value="">S√©lectionnez votre type de compteur</option>
            <option value="Compteur classique">‚öôÔ∏è Compteur classique</option>
            <option value="Compteur LINKY">üì° Compteur LINKY</option>
          </select>
          {errors.meterType && <span className="error-message">{errors.meterType}</span>}
        </div>
        
        <div className="form-group">
          <label>‚ö° Puissance compteur (kW) *</label>
          <input
            type="number"
            value={formData.meterPower}
            onChange={(e) => setFormData({...formData, meterPower: e.target.value})}
            placeholder="ex: 6, 9, 12, 14, 18, 22"
            min="3"
            max="36"
            step="1"
            className={errors.meterPower ? 'error' : ''}
            required
          />
          {errors.meterPower && <span className="error-message">{errors.meterPower}</span>}
          <small>üí° Puissance standard : 6kW, 9kW, 12kW, 14kW, 18kW, 22kW</small>
        </div>
        
        <div className="form-group">
          <label>üîå Monophas√© - Triphas√© *</label>
          <select
            value={formData.phaseType}
            onChange={(e) => setFormData({...formData, phaseType: e.target.value})}
            className={errors.phaseType ? 'error' : ''}
            required
          >
            <option value="">S√©lectionnez le type de phase</option>
            <option value="Monophas√©">üîå Monophas√©</option>
            <option value="Triphas√©">üîåüîåüîå Triphas√©</option>
          </select>
          {errors.phaseType && <span className="error-message">{errors.phaseType}</span>}
        </div>
        
        <div className="form-buttons">
          <button type="button" onClick={onPrevious} className="prev-button">‚¨ÖÔ∏è Pr√©c√©dent</button>
          <button type="submit" className="next-button">Suivant ‚û°Ô∏è</button>
        </div>
      </form>
    </div>
  );
};

// Formulaire √©tape 4 - Consommation am√©lior√©
const ConsumptionForm = ({ formData, setFormData, onNext, onPrevious }) => {
  const [errors, setErrors] = useState({});
  const [showKitSelection, setShowKitSelection] = useState(false);
  const [availableKits, setAvailableKits] = useState([]);
  const [selectedKit, setSelectedKit] = useState(null);
  const [loadingKits, setLoadingKits] = useState(false);

  // R√©cup√©rer les kits solaires disponibles
  const fetchAvailableKits = async () => {
    if (availableKits.length > 0) return; // D√©j√† charg√©s
    
    setLoadingKits(true);
    try {
      // Utiliser le nouvel endpoint qui prend en compte le mode client
      const clientMode = formData.clientMode || 'particuliers';
      const response = await fetch(`${API}/solar-kits/${clientMode}`);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const kits = await response.json();
      
      // Transformer les donn√©es pour inclure les informations calcul√©es
      const kitsWithDetails = Object.entries(kits).map(([power, info]) => {
        const kitPower = parseInt(power);
        
        if (clientMode === 'professionnels') {
          // Pour les professionnels, utiliser les donn√©es du tableau
          return {
            power: kitPower,
            panels: info.panels,
            surface: info.surface,
            prime: info.prime,
            priceTTC: info.tarif_base_ht, // Prix de base HT
            priceHT: info.tarif_base_ht,
            priceRemise: info.tarif_remise_ht,
            priceRemiseMax: info.tarif_remise_max_ht,
            commissionNormale: info.commission_normale,
            commissionRemiseMax: info.commission_remise_max,
            priceWithAids: info.tarif_base_ht - info.prime, // Prix base - prime
            commission: info.commission_normale // Commission par d√©faut
          };
        } else {
          // Pour les particuliers, calcul traditionnel
          const priceHT = info.price / 1.2; // Prix HT (TTC / 1.2)
          const commission = priceHT * 0.15; // Commission 15%
          const surfaceTotal = info.panels * 2.1; // Surface par panneau: 2.1m¬≤
          
          const autoconsumptionAid = kitPower * 80; // 80‚Ç¨/kW
          const tvaRefund = kitPower > 3 ? info.price * 0.2 : 0; // TVA 20% si > 3kW
          const totalAids = autoconsumptionAid + tvaRefund;
          const priceWithAids = info.price - totalAids;
          
          return {
            power: kitPower,
            panels: info.panels,
            priceTTC: info.price,
            priceHT: Math.round(priceHT),
            commission: Math.round(commission),
            surface: surfaceTotal,
            autoconsumptionAid,
            tvaRefund: Math.round(tvaRefund),
            totalAids: Math.round(totalAids),
            priceWithAids: Math.round(priceWithAids)
          };
        }
      });
      
      setAvailableKits(kitsWithDetails.sort((a, b) => a.power - b.power));
    } catch (error) {
      console.error('Erreur lors du chargement des kits:', error);
      alert('Erreur lors du chargement des kits. Veuillez r√©essayer.');
    }
    setLoadingKits(false);
  };

  const handleShowKitSelection = () => {
    setShowKitSelection(true);
    fetchAvailableKits();
  };

  const handleSelectKit = (kit) => {
    setSelectedKit(kit);
    // Mettre √† jour le formData avec le kit s√©lectionn√©
    setFormData(prev => ({
      ...prev,
      selectedManualKit: kit
    }));
  };

  const handleConfirmKitSelection = () => {
    if (selectedKit) {
      setFormData(prev => ({
        ...prev,
        useManualKit: true,
        manualKit: selectedKit
      }));
      setShowKitSelection(false);
      alert(`Kit ${selectedKit.power}kW s√©lectionn√© avec succ√®s !`);
    }
  };

  const handleCancelKitSelection = () => {
    setShowKitSelection(false);
    setSelectedKit(null);
    setFormData(prev => ({
      ...prev,
      useManualKit: false,
      manualKit: null,
      selectedManualKit: null
    }));
  };

  const validateForm = () => {
    const newErrors = {};
    if (!formData.annualConsumption || formData.annualConsumption < 1000) {
      newErrors.annualConsumption = "Consommation minimum : 1000 kWh/an";
    }
    if (!formData.monthlyEdfPayment || formData.monthlyEdfPayment < 30) {
      newErrors.monthlyEdfPayment = "Montant minimum : 30 ‚Ç¨/mois";
    }
    
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (validateForm()) {
      onNext();
    }
  };

  // Calcul automatique du total annuel
  const calculateAnnualTotal = (monthly) => {
    return monthly * 12; // 12 mois pour calcul annuel
  };

  const getConsumptionAdvice = (consumption) => {
    if (consumption < 3000) return "üü¢ Consommation faible - Kit 3-4 kW recommand√©";
    if (consumption < 6000) return "üü° Consommation moyenne - Kit 5-6 kW recommand√©";
    if (consumption < 9000) return "üü† Consommation √©lev√©e - Kit 7-8 kW recommand√©";
    return "üî¥ Consommation tr√®s √©lev√©e - Kit 9 kW+ recommand√©";
  };

  return (
    <div className="form-container">
      <div className="form-header">
        <h2>‚ö° √âtape 4/4 - Consommation √âlectrique</h2>
        <div className="progress-bar">
          <div className="progress-fill" style={{width: '100%'}}></div>
        </div>
      </div>
      
      <form onSubmit={handleSubmit}>
        <div className="form-group">
          <label>üìä Consommation annuelle en kWh *</label>
          <input
            type="number"
            value={formData.annualConsumption}
            onChange={(e) => setFormData({...formData, annualConsumption: e.target.value})}
            placeholder="ex: 6500"
            min="1000"
            max="20000"
            className={errors.annualConsumption ? 'error' : ''}
            required
          />
          {errors.annualConsumption && <span className="error-message">{errors.annualConsumption}</span>}
          {formData.annualConsumption && (
            <div className="consumption-advice">{getConsumptionAdvice(formData.annualConsumption)}</div>
          )}
          <small>üí° Trouvez cette info sur votre facture EDF ou votre espace client</small>
        </div>
        
        <div className="form-group">
          <label>üí≥ Mensualit√© pr√©lev√©e par EDF (‚Ç¨) *</label>
          <input
            type="number"
            value={formData.monthlyEdfPayment}
            onChange={(e) => {
              const monthly = e.target.value;
              setFormData({
                ...formData, 
                monthlyEdfPayment: monthly,
                annualEdfPayment: calculateAnnualTotal(monthly)
              });
            }}
            placeholder="ex: 180"
            min="30"
            max="500"
            className={errors.monthlyEdfPayment ? 'error' : ''}
            required
          />
          {errors.monthlyEdfPayment && <span className="error-message">{errors.monthlyEdfPayment}</span>}
          <small>üí° Montant pr√©lev√© chaque mois sur votre compte</small>
        </div>
        
        {formData.monthlyEdfPayment && (
          <div className="form-group">
            <label>üí∞ Total pay√© √† l'ann√©e (‚Ç¨)</label>
            <input
              type="number"
              value={formData.annualEdfPayment}
              readOnly
              className="readonly-field"
            />
          </div>
        )}

        {/* Section de s√©lection manuelle des kits */}
        {formData.monthlyEdfPayment && (
          <div className="kit-selection-section">
            {!showKitSelection ? (
              <div className="kit-selection-toggle">
                <button 
                  type="button" 
                  className="show-kits-button"
                  onClick={handleShowKitSelection}
                >
                  üìã Voir tous les kits disponibles avec puissances et surfaces
                </button>
                <small>Cliquez pour voir la liste compl√®te des kits et s√©lectionner manuellement</small>
              </div>
            ) : (
              <div className="kit-selection-panel">
                <div className="kit-selection-header">
                  <h4>üîß S√©lection manuelle du kit solaire</h4>
                  <button 
                    type="button" 
                    className="close-kits-button"
                    onClick={handleCancelKitSelection}
                  >
                    ‚úï Fermer
                  </button>
                </div>
                
                {loadingKits ? (
                  <div className="loading-kits">
                    <div className="loading-spinner"></div>
                    <p>Chargement des kits disponibles...</p>
                  </div>
                ) : (
                  <div className="kits-grid">
                    {availableKits.map((kit) => (
                      <div 
                        key={kit.power} 
                        className={`kit-card ${selectedKit?.power === kit.power ? 'selected' : ''}`}
                        onClick={() => handleSelectKit(kit)}
                      >
                        <div className="kit-header">
                          <h5>Kit {kit.power}kW</h5>
                          <span className="kit-panels">{kit.panels} panneaux</span>
                        </div>
                        
                        <div className="kit-details">
                          <div className="kit-detail-row">
                            <span>Surface totale:</span>
                            <span>{kit.surface}m¬≤</span>
                          </div>
                          
                          {formData.clientMode === 'professionnels' ? (
                            <>
                              <div className="kit-detail-row">
                                <span>Prix de base HT:</span>
                                <span>{kit.priceHT.toLocaleString()}‚Ç¨</span>
                              </div>
                              <div className="kit-detail-row">
                                <span>Prix remis√© HT:</span>
                                <span>{kit.priceRemise.toLocaleString()}‚Ç¨</span>
                              </div>
                              <div className="kit-detail-row">
                                <span>Prix remis√© MAX HT:</span>
                                <span className="price-remise-max">{kit.priceRemiseMax.toLocaleString()}‚Ç¨</span>
                              </div>
                              <div className="kit-detail-row">
                                <span>Prime subvention:</span>
                                <span className="prime-amount">{kit.prime.toLocaleString()}‚Ç¨</span>
                              </div>
                              <div className="kit-detail-row">
                                <span>Commission normale:</span>
                                <span className="commission">{kit.commissionNormale.toLocaleString()}‚Ç¨</span>
                              </div>
                              <div className="kit-detail-row">
                                <span>Commission remise MAX:</span>
                                <span className="commission-max">{kit.commissionRemiseMax.toLocaleString()}‚Ç¨</span>
                              </div>
                            </>
                          ) : (
                            <>
                              <div className="kit-detail-row">
                                <span>Prix TTC:</span>
                                <span>{kit.priceTTC.toLocaleString()}‚Ç¨</span>
                              </div>
                              <div className="kit-detail-row">
                                <span>Prix avec aides:</span>
                                <span className="price-with-aids">{kit.priceWithAids.toLocaleString()}‚Ç¨</span>
                              </div>
                              <div className="kit-detail-row commission">
                                <span>CO2 √©conomis√©:</span>
                                <span>{kit.commission} kilos/an</span>
                              </div>
                            </>
                          )}
                        </div>
                        
                        {selectedKit?.power === kit.power && (
                          <div className="kit-selected-indicator">
                            ‚úì S√©lectionn√©
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                )}
                
                {selectedKit && !loadingKits && (
                  <div className="kit-selection-actions">
                    <button 
                      type="button" 
                      className="confirm-kit-button"
                      onClick={handleConfirmKitSelection}
                    >
                      ‚úì Confirmer la s√©lection du Kit {selectedKit.power}kW
                    </button>
                    <button 
                      type="button" 
                      className="cancel-kit-button"
                      onClick={handleCancelKitSelection}
                    >
                      ‚úï Annuler et utiliser la recommandation automatique
                    </button>
                  </div>
                )}
                
                <div className="kit-selection-note">
                  <p><strong>‚ÑπÔ∏è Mode commercial :</strong> Cette s√©lection remplacera la recommandation automatique pour les calculs suivants.</p>
                </div>
              </div>
            )}
            
            {formData.useManualKit && formData.manualKit && (
              <div className="manual-kit-selected">
                <div className="selected-kit-info">
                  <h5>üéØ Kit s√©lectionn√© manuellement</h5>
                  <div className="selected-kit-details">
                    <span>Kit {formData.manualKit.power}kW ({formData.manualKit.panels} panneaux)</span>
                    <span>Prix avec aides: {formData.manualKit.priceWithAids.toLocaleString()}‚Ç¨</span>
                  </div>
                  <button 
                    type="button" 
                    className="change-kit-button"
                    onClick={handleShowKitSelection}
                  >
                    üîÑ Changer de kit
                  </button>
                </div>
              </div>
            )}
          </div>
        )}
        
        <div className="consumption-summary">
          <h4>üìã R√©sum√© de votre profil :</h4>
          <p><strong>üè†</strong> {formData.firstName} {formData.lastName}</p>
          <p><strong>üìç</strong> {formData.address}</p>
          <p><strong>üìê</strong> {formData.roofSurface} m¬≤ - {formData.roofOrientation}</p>
          <p><strong>‚ö°</strong> {formData.annualConsumption} kWh/an</p>
        </div>
        
        <div className="form-buttons">
          <button type="button" onClick={onPrevious} className="prev-button">‚¨ÖÔ∏è Pr√©c√©dent</button>
          <button type="submit" className="next-button">üöÄ Commencer le Calcul PVGIS</button>
        </div>
      </form>
    </div>
  );
};

// √âcran de r√©sultats - Version Premium avec g√©n√©ration PDF
const ResultsScreen = ({ results, onPrevious }) => {
  const [activeTab, setActiveTab] = useState('overview');
  const [showFinancing, setShowFinancing] = useState(false);
  const [isGeneratingPDF, setIsGeneratingPDF] = useState(false);

  const generatePDF = async () => {
    try {
      setIsGeneratingPDF(true);
      
      // Afficher un message de g√©n√©ration
      const notification = document.createElement('div');
      notification.className = 'pdf-notification';
      notification.innerHTML = 'üìÑ G√©n√©ration du rapport PDF en cours...';
      document.body.appendChild(notification);
      
      // Appel √† l'API pour g√©n√©rer le PDF
      const response = await fetch(`${API}/generate-pdf/${results.client_id}`, {
        method: 'GET',
        headers: {
          'Accept': 'application/pdf',
        },
      });
      
      if (response.ok) {
        // Cr√©er un blob et t√©l√©charger le fichier
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        
        // Nom du fichier avec date
        const today = new Date().toISOString().split('T')[0].replace(/-/g, '');
        link.download = `etude_solaire_FRH_${today}.pdf`;
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
        
        // Message de succ√®s
        notification.innerHTML = '‚úÖ Rapport PDF t√©l√©charg√© avec succ√®s !';
        notification.style.backgroundColor = '#4caf50';
        
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 3000);
      } else {
        throw new Error('Erreur lors de la g√©n√©ration du PDF');
      }
    } catch (error) {
      console.error('Erreur PDF:', error);
      alert(`‚ùå Erreur lors de la g√©n√©ration du PDF: ${error.message}\n\nVeuillez r√©essayer ou contacter le support.`);
    } finally {
      setIsGeneratingPDF(false);
    }
  };

  const getAutonomyColor = (percentage) => {
    if (percentage >= 80) return '#4caf50';
    if (percentage >= 60) return '#ff9800';
    return '#f44336';
  };

  const getOptimalFinancing = () => {
    if (!results.financing_options) return null;
    return results.financing_options.find(option => 
      option.difference_vs_savings >= -20 && option.difference_vs_savings <= 20
    ) || results.financing_options[results.financing_options.length - 1];
  };

  const optimalFinancing = getOptimalFinancing();

  const sendToExpert = () => {
    const subject = encodeURIComponent(`Demande de rendez-vous - √âtude solaire ${results.kit_power}kW`);
    const body = encodeURIComponent(`Bonjour,

Suite √† mon √©tude solaire personnalis√©e, je souhaiterais prendre rendez-vous pour finaliser mon projet d'installation.

R√©sum√© de mon √©tude :
- Kit recommand√© : ${results.kit_power}kW (${results.panel_count} panneaux)
- Production estim√©e : ${Math.round(results.estimated_production)} kWh/an
- Autonomie : ${Math.round(results.autonomy_percentage)}%
- √âconomies : ${Math.round(results.estimated_savings)} ‚Ç¨/an
- Investissement : ${results.kit_price?.toLocaleString()} ‚Ç¨ TTC

Je suis disponible pour un rendez-vous dans les prochains jours.

Cordialement`);
    
    window.open(`mailto:contact@francerenovhabitat.com?subject=${subject}&body=${body}`);
  };

  return (
    <div className="results-screen">
      <div className="results-header">
        <h2>üéâ Votre Solution Solaire Personnalis√©e</h2>
        <p>√âtude r√©alis√©e avec les donn√©es officielles PVGIS Commission Europ√©enne</p>
        
        <div className="success-badges">
          <div className="badge-item">
            <span className="badge-icon">üèÜ</span>
            <span>RGE QualiPV</span>
          </div>
          <div className="badge-item">
            <span className="badge-icon">üõ°Ô∏è</span>
            <span>Garantie 10 ans</span>
          </div>
          <div className="badge-item">
            <span className="badge-icon">‚ö°</span>
            <span>PVGIS Officiel</span>
          </div>
        </div>
        
        <div className="results-tabs">
          <button 
            className={`tab-button ${activeTab === 'overview' ? 'active' : ''}`}
            onClick={() => setActiveTab('overview')}
          >
            üìä Vue d'ensemble
          </button>
          <button 
            className={`tab-button ${activeTab === 'technical' ? 'active' : ''}`}
            onClick={() => setActiveTab('technical')}
          >
            üîß D√©tails techniques
          </button>
          <button 
            className={`tab-button ${activeTab === 'financial' ? 'active' : ''}`}
            onClick={() => setActiveTab('financial')}
          >
            üí∞ Analyse financi√®re
          </button>
        </div>
      </div>
      
      {activeTab === 'overview' && (
        <div className="tab-content">
          <div className="results-grid">
            <div className="result-card primary">
              <div className="card-icon">‚ö°</div>
              <h3>Kit Solaire Optimal</h3>
              <div className="big-number">{results.kit_power} kW</div>
              <p>{results.panel_count} panneaux de 500W</p>
              <p className="price">{results.kit_price?.toLocaleString()} ‚Ç¨ TTC</p>
              <div className="card-footer">
                <small>Surface n√©cessaire: {results.panel_count * 2.1} m¬≤</small>
              </div>
            </div>

            <div className="result-card success">
              <div className="card-icon">üîã</div>
              <h3>Autonomie √ânerg√©tique</h3>
              <div className="big-number" style={{color: 'white'}}>
                {Math.round(results.autonomy_percentage)}%
              </div>
              <p>Autoconsommation optimis√©e</p>
              <div className="autonomy-bar">
                <div 
                  className="autonomy-fill" 
                  style={{
                    width: `${results.autonomy_percentage}%`,
                    backgroundColor: getAutonomyColor(results.autonomy_percentage)
                  }}
                ></div>
              </div>
            </div>

            <div className="result-card production">
              <div className="card-icon">‚òÄÔ∏è</div>
              <h3>Production Annuelle</h3>
              <div className="big-number">{Math.round(results.estimated_production)} kWh</div>
              <p>Donn√©es PVGIS officielles</p>
              <p>Orientation: {results.orientation}</p>
              <div className="card-footer">
                <small>Soit {Math.round(results.estimated_production/365)} kWh/jour</small>
              </div>
            </div>

            <div className="result-card savings">
              <div className="card-icon">üí∞</div>
              <h3>√âconomies Garanties</h3>
              <div className="big-number">{Math.round(results.estimated_savings)} ‚Ç¨</div>
              <p>Soit {Math.round(results.monthly_savings)} ‚Ç¨/mois</p>
              <div className="savings-breakdown">
                <small>Autoconsommation: {Math.round(results.autoconsumption_kwh)} kWh</small>
                <small>Surplus vendu: {Math.round(results.surplus_kwh)} kWh</small>
              </div>
            </div>
          </div>

          <div className="impact-section">
            <h3>üå± Impact Environnemental</h3>
            <div className="impact-grid">
              <div className="impact-card">
                <h4>üå≥ CO‚ÇÇ √©vit√©</h4>
                <p className="impact-value">{Math.round(results.estimated_production * 0.0571)} kg/an</p>
                <small>√âquivalent √† {Math.round(results.estimated_production * 0.0571 / 25)} arbres plant√©s</small>
              </div>
              <div className="impact-card">
                <h4>üè† Plus-value immobili√®re</h4>
                <p className="impact-value">Classe A/B</p>
                <small>Augmentation significative de la valeur du bien</small>
              </div>
              <div className="impact-card">
                <h4>‚ö° Ind√©pendance</h4>
                <p className="impact-value">{Math.round(results.autonomy_percentage)}% autonome</p>
                <small>Protection contre la hausse des tarifs</small>
              </div>
            </div>
          </div>
        </div>
      )}

      {activeTab === 'technical' && (
        <div className="tab-content">
          <div className="technical-details">
            <div className="tech-section">
              <h3>üîß Sp√©cifications techniques</h3>
              <div className="tech-grid">
                <div className="tech-item">
                  <strong>Panneaux:</strong> {results.panel_count} √ó 500W monocristallin
                </div>
                <div className="tech-item">
                  <strong>Onduleur:</strong> Hoymiles haute performance (99,8%)
                </div>
                <div className="tech-item">
                  <strong>Garanties:</strong> 25 ans production + 10 ans d√©cennale
                </div>
                <div className="tech-item">
                  <strong>Syst√®me:</strong> Anti-surtension int√©gr√© + arr√™t rapide
                </div>
                <div className="tech-item">
                  <strong>Suivi:</strong> Application mobile temps r√©el
                </div>
                <div className="tech-item">
                  <strong>Installation:</strong> En surimposition toiture
                </div>
              </div>
            </div>

            <div className="monthly-production">
              <h3>üìä Production mensuelle d√©taill√©e</h3>
              <div className="monthly-chart">
                {results.pvgis_monthly_data?.map((month) => (
                  <div key={month.month} className="month-bar">
                    <div 
                      className="bar" 
                      style={{height: `${(month.E_m / Math.max(...results.pvgis_monthly_data.map(m => m.E_m))) * 100}%`}}
                    ></div>
                    <span className="month-label">{['J','F','M','A','M','J','J','A','S','O','N','D'][month.month-1]}</span>
                    <span className="month-value">{Math.round(month.E_m)} kWh</span>
                  </div>
                ))}
              </div>
            </div>

            <div className="coordinates-info">
              <h3>üåç Donn√©es g√©ographiques</h3>
              <p><strong>Coordonn√©es:</strong> {results.coordinates?.lat.toFixed(4)}¬∞N, {results.coordinates?.lon.toFixed(4)}¬∞E</p>
              <p><strong>Source:</strong> {results.pvgis_source}</p>
              <p><strong>Irradiation globale:</strong> ~{Math.round(results.estimated_production / results.kit_power)} kWh/kWc/an</p>
            </div>
          </div>
        </div>
      )}

      {activeTab === 'financial' && (
        <div className="tab-content">
          {/* Affichage conditionnel selon le mode client */}
          {results.client_mode === 'professionnels' ? (
            <div className="professional-results">
              {/* Section MEILLEUR KITS OPTIMISE */}
              {results.optimal_kit && (
                <div className="optimal-kit-section">
                  <h3>üéØ MEILLEUR KITS OPTIMISE</h3>
                  <div className="optimal-kit-card">
                    <div className="optimal-kit-header">
                      <h4>Kit {results.optimal_kit.kit_power}kW - Leasing {results.optimal_kit.duration_months} mois</h4>
                      <span className="optimal-badge">RECOMMAND√â</span>
                    </div>
                    <div className="optimal-kit-details">
                      <div className="optimal-detail-row">
                        <span>Mensualit√© leasing :</span>
                        <span className="leasing-payment">{results.optimal_kit.monthly_payment?.toFixed(2)}‚Ç¨/mois</span>
                      </div>
                      <div className="optimal-detail-row">
                        <span>√âconomies mensuelles :</span>
                        <span className="monthly-savings">{results.optimal_kit.monthly_savings?.toFixed(2)}‚Ç¨/mois</span>
                      </div>
                      <div className="optimal-detail-row benefit">
                        <span>B√©n√©fice mensuel :</span>
                        <span className="monthly-benefit">+{results.optimal_kit.monthly_benefit?.toFixed(2)}‚Ç¨/mois</span>
                      </div>
                      <div className="optimal-detail-row">
                        <span>Niveau de prix :</span>
                        <span className="price-level">{results.optimal_kit.price_level || 'base'}</span>
                      </div>
                    </div>
                  </div>
                </div>
              )}
              
              {/* Section Options de Leasing */}
              {results.leasing_options && results.leasing_options.length > 0 && (
                <div className="leasing-options-section">
                  <h3>üí∞ Options de Leasing Disponibles</h3>
                  <div className="leasing-options-grid">
                    {results.leasing_options.map((option, index) => (
                      <div key={index} className="leasing-option-card">
                        <div className="leasing-option-header">
                          <h4>{option.duration_months} mois</h4>
                          <span className="leasing-rate">{option.rate}%</span>
                        </div>
                        <div className="leasing-option-details">
                          <div className="leasing-detail-row">
                            <span>Mensualit√© :</span>
                            <span className="monthly-payment">{option.monthly_payment?.toFixed(2)}‚Ç¨</span>
                          </div>
                          <div className="leasing-detail-row">
                            <span>Total pay√© :</span>
                            <span className="total-payment">{option.total_payment?.toFixed(2)}‚Ç¨</span>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Section Analyse Financi√®re Professionnelle */}
              <div className="professional-financial-analysis">
                <h3>üìä Analyse Financi√®re Professionnelle</h3>
                <div className="financial-cards">
                  <div className="financial-card">
                    <h4>üè≠ Avantages Professionnels</h4>
                    <div className="financial-details">
                      <div className="financial-row">
                        <span>Prime subvention :</span>
                        <span className="prime-amount">{results.autoconsumption_aid?.toFixed(2)}‚Ç¨</span>
                      </div>
                      <div className="financial-row">
                        <span>TVA r√©cup√©r√©e :</span>
                        <span className="tva-benefit">Oui (par l'entreprise)</span>
                      </div>
                      <div className="financial-row">
                        <span>Amortissement acc√©l√©r√© :</span>
                        <span className="amortissement">30% premi√®re ann√©e</span>
                      </div>
                    </div>
                  </div>
                  
                  <div className="financial-card">
                    <h4>‚ö° Consommation Professionnelle</h4>
                    <div className="financial-details">
                      <div className="financial-row">
                        <span>Autoconsommation :</span>
                        <span className="autoconsumption">{results.autoconsumption_kwh?.toFixed(0)} kWh (80%)</span>
                      </div>
                      <div className="financial-row">
                        <span>Surplus revendu :</span>
                        <span className="surplus">{results.surplus_kwh?.toFixed(0)} kWh (20%)</span>
                      </div>
                      <div className="financial-row">
                        <span>Tarif EDF pro :</span>
                        <span className="edf-rate">0.26‚Ç¨/kWh</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          ) : (
            // Affichage traditionnel pour les particuliers
            <div className="financing-section">
              <h3>üí∞ Analyse financi√®re compl√®te</h3>
              
              <div className="financial-summary">
                <div className="financial-item">
                  <span className="financial-label">üí≥ Investissement:</span>
                  <span className="financial-value">{results.kit_price?.toLocaleString()} ‚Ç¨ TTC</span>
                </div>
                <div className="financial-item">
                  <span className="financial-label">üéÅ Aides totales:</span>
                  <span className="financial-value success">-{Math.round(results.total_aids)} ‚Ç¨</span>
                </div>
                <div className="financial-item">
                  <span className="financial-label">üí∏ Reste √† financer:</span>
                  <span className="financial-value">{(results.kit_price - results.total_aids).toLocaleString()} ‚Ç¨</span>
                </div>
                <div className="financial-item">
                  <span className="financial-label">‚è±Ô∏è Retour sur investissement:</span>
                  <span className="financial-value">{Math.round((results.kit_price - results.total_aids) / results.estimated_savings)} ans</span>
                </div>
              </div>

              <div className="aids-breakdown">
                <h4>üéÅ D√©tail des aides disponibles</h4>
                <div className="aid-item">
                  <span>Prime autoconsommation EDF (vers√©e √† M+6):</span>
                  <span className="aid-amount">{results.autoconsumption_aid} ‚Ç¨</span>
                </div>
                {results.tva_refund > 0 && (
                  <div className="aid-item">
                    <span>TVA rembours√©e 20% (vers√©e √† M+12):</span>
                    <span className="aid-amount">{Math.round(results.tva_refund)} ‚Ç¨</span>
                  </div>
                )}
                <div className="aid-item total-aid">
                  <span><strong>Total des aides r√©cup√©rables:</strong></span>
                  <span className="aid-amount"><strong>{Math.round(results.total_aids)} ‚Ç¨</strong></span>
                </div>
              </div>

              <div className="results-footer">
                <div className="action-buttons">
                  <button type="button" onClick={onPrevious} className="prev-button">‚¨ÖÔ∏è Modifier les donn√©es</button>
                  <button 
                    type="button" 
                    onClick={generatePDF} 
                    className={`pdf-button ${isGeneratingPDF ? 'generating' : ''}`}
                    disabled={isGeneratingPDF}
                  >
                    {isGeneratingPDF ? '‚è≥ G√©n√©ration...' : 'üìÑ T√©l√©charger le Rapport PDF Complet'}
                  </button>
                  <button type="button" onClick={sendToExpert} className="expert-button">
                    üë®‚Äçüíº Prendre RDV avec un Expert
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      )}

            {optimalFinancing && (
              <div className="optimal-financing">
                <h4>üè¶ Options de financement recommand√©es</h4>
                
                {/* Financement sans aides d√©duites */}
                <div className="financing-card highlighted">
                  <div className="financing-header">
                    <h5>‚≠ê Financement standard sur {optimalFinancing.duration_years} ans</h5>
                    <span className="financing-type">Sans aides d√©duites</span>
                  </div>
                  <div className="financing-details">
                    <div className="financing-row">
                      <span>Investissement total:</span>
                      <span className="amount">{results.kit_price?.toLocaleString()} ‚Ç¨ TTC</span>
                    </div>
                    <div className="financing-row">
                      <span>Mensualit√© cr√©dit:</span>
                      <span className="amount">{Math.round(optimalFinancing.monthly_payment)} ‚Ç¨/mois</span>
                    </div>
                    <div className="financing-row">
                      <span>√âconomie EDF:</span>
                      <span className="amount success">{Math.round(results.monthly_savings)} ‚Ç¨/mois</span>
                    </div>
                    <div className="financing-row">
                      <span>Reste √† charge:</span>
                      <span className={`amount ${optimalFinancing.difference_vs_savings < 0 ? 'success' : 'warning'}`}>
                        {optimalFinancing.difference_vs_savings > 0 ? '+' : ''}{Math.round(optimalFinancing.difference_vs_savings)} ‚Ç¨/mois
                      </span>
                    </div>
                  </div>
                </div>

                {/* Financement avec aides d√©duites */}
                <div className="financing-card highlighted-green">
                  <div className="financing-header">
                    <h5>üí∞ Financement optimis√© sur {results.financing_with_aids?.duration_years} ans</h5>
                    <span className="recommended-badge green">Avec aides d√©duites</span>
                  </div>
                  <div className="financing-details">
                    <div className="financing-row">
                      <span>Investissement apr√®s aides:</span>
                      <span className="amount">{results.financing_with_aids?.financed_amount?.toLocaleString()} ‚Ç¨ TTC</span>
                    </div>
                    <div className="financing-row">
                      <span>Mensualit√© cr√©dit r√©duite:</span>
                      <span className="amount success">{Math.round(results.financing_with_aids?.monthly_payment)} ‚Ç¨/mois</span>
                    </div>
                    <div className="financing-row">
                      <span>√âconomie EDF:</span>
                      <span className="amount success">{Math.round(results.monthly_savings)} ‚Ç¨/mois</span>
                    </div>
                    <div className="financing-row">
                      <span>Reste √† charge optimis√©:</span>
                      <span className="amount success">
                        {Math.round(results.financing_with_aids?.difference_vs_savings)} ‚Ç¨/mois
                      </span>
                    </div>
                  </div>
                  <div className="financing-benefits">
                    <p>‚úÖ 6 premiers mois GRATUITS (Rien √† d√©bourser pendant les 6 premiers mois)</p>
                    <p>‚úÖ Aides r√©cup√©r√©es: {Math.round(results.total_aids)} ‚Ç¨ (Prime + TVA)</p>
                    <p>‚úÖ R√©injection des Aides et Subventions r√©cup√©r√©es entre le 7√®me et 12√®me mois</p>
                  </div>
                </div>
              </div>
            )}

            <button 
              className="show-all-financing-btn"
              onClick={() => setShowFinancing(!showFinancing)}
            >
              {showFinancing ? 'üìä Masquer' : 'üìä Voir toutes les options'} de financement
            </button>

            {showFinancing && (
              <div className="all-financing-options">
                <h4>üìä Toutes les options de financement disponibles</h4>
                <div className="financing-table">
                  <div className="table-header">
                    <span>Dur√©e</span>
                    <span>Mensualit√©</span>
                    <span>Diff√©rence vs √©conomies</span>
                  </div>
                  {results.financing_options?.map((option, index) => (
                    <div key={index} className="table-row">
                      <span>{option.duration_years} ans</span>
                      <span>{Math.round(option.monthly_payment)} ‚Ç¨</span>
      )}

      <div className="results-footer">
        <div className="action-buttons">
          <button type="button" onClick={onPrevious} className="prev-button">‚¨ÖÔ∏è Modifier les donn√©es</button>
          <button 
            type="button" 
            onClick={generatePDF} 
            className={`pdf-button ${isGeneratingPDF ? 'generating' : ''}`}
            disabled={isGeneratingPDF}
          >
            {isGeneratingPDF ? '‚è≥ G√©n√©ration...' : 'üìÑ T√©l√©charger le Rapport PDF Complet'}
          </button>
          <button type="button" onClick={sendToExpert} className="expert-button">
            üë®‚Äçüíº Prendre RDV avec un Expert
          </button>
        </div>
      </div>

      <div className="results-footer">
        <div className="action-buttons">
          <button type="button" onClick={onPrevious} className="prev-button">‚¨ÖÔ∏è Modifier les donn√©es</button>
          <button 
            type="button" 
            onClick={generatePDF} 
            className={`pdf-button ${isGeneratingPDF ? 'generating' : ''}`}
            disabled={isGeneratingPDF}
          >
            {isGeneratingPDF ? '‚è≥ G√©n√©ration...' : 'üìÑ T√©l√©charger le Rapport PDF Complet'}
          </button>
          <button type="button" onClick={sendToExpert} className="expert-button">
            üë®‚Äçüíº Prendre RDV avec un Expert
          </button>
        </div>
      </div>
    </div>
  );
};

export default App;
